<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <title>FinanceDashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/financedashboard.webflow.css" rel="stylesheet" type="text/css">
</head>

<body>
  <section class="header_section">
    <div class="div-block-14">
      <h1 class="logo">FINANCEXPLANER</h1>
      <div class="text-block-3" id="user-email">USERNAME</div>
    </div>
  </section>

  <section class="tabs_section">
    <div class="tabs_wrapper">
      <div class="tabs w-tabs">
        <div class="tabs-menu w-tab-menu">
          <a data-w-tab="Tab 1" class="tab-link-tab-1 w-inline-block w-tab-link w--current">
            <div>Tab 1</div>
          </a>
          <a data-w-tab="Tab 2" class="tab-link-tab-2 w-inline-block w-tab-link">
            <div>Tab 2</div>
          </a>
          <a data-w-tab="Tab 3" class="tab-link-tab-3 w-inline-block w-tab-link">
            <div>Tab 3</div>
          </a>
        </div>
        <div class="tabs-content w-tab-content">
          <div data-w-tab="Tab 1" class="w-tab-pane w--tab-active">
            <section class="config-step-2">
              <div class="prawiegotowewrapper">
                <div class="div-block-10">
                  <h1 class="heading-4">Prawie gotowe...</h1>
                </div>
                <div class="div-block-9">
                  <p class="paragraph">Teraz tylko powiąż bota z Twoim kontem klikając w ten link!</p>
                </div>
                <div class="div-block-7">
                  <div class="form-block w-form">
                    <form class="form"><label class="field-label"><strong>Otwórz bota w telegramie:</strong></label>
                      <div class="div-block-16"><input type="submit" class="submit-button w-button" value="Otwórz bota"
                          id="bot-link-button"></div>
                    </form>
                  </div>
                </div>
              </div>
            </section>
            <section class="config-step-3" style="display: none;">
              <div class="botdzialawrapper">
                <div class="div-block-10">
                  <h1 class="heading-4">Bot działa</h1>
                </div>
                <div class="div-block-9">
                  <p class="paragraph">AI przeanalizuje wiadomości i zapisze dane do tabeli! Komendy:</p>
                </div>
                <div class="komendy">
                  <div class="div-block-12">
                    <div class="komenda">Proszę o podsumowanie lub /podsumowanie</div>
                  </div>
                  <div class="opis">- aby otrzymać podsumowanie wydatków</div>
                </div>
                <div class="komendy">
                  <div class="div-block-12">
                    <div class="komenda">Proszę o link lub /link</div>
                  </div>
                  <div class="opis">- aby dostać link do arkusza</div>
                </div>
              </div>
            </section>
          </div>
          <div data-w-tab="Tab 2" class="w-tab-pane"></div>
          <div data-w-tab="Tab 3" class="w-tab-pane"></div>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://vptpascqhmpmgnufevks.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdHBhc2NxaG1wbWdudWZldmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NTcwNDEsImV4cCI6MjA2MzIzMzA0MX0.5Vtk65gjiUG0VrBqbukwikF02SX5z55xV-Ag3U4CGp0"
    );

    document.addEventListener("DOMContentLoaded", async () => {
      const step2 = document.querySelector(".config-step-2");
      const step3 = document.querySelector(".config-step-3");
      const emailText = document.getElementById("user-email");
      const botButton = document.getElementById("bot-link-button");

      const { data: { session } } = await supabase.auth.getSession();

      if (!session?.user) {
        window.location.href = "/logowanie/index.html";
        return;
      }

      const userId = session.user.id;
      const email = session.user.email;
      emailText.innerText = email;

      // Sprawdź, czy użytkownik istnieje
      const { data: existingUser, error: selectError } = await supabase
        .from("users")
        .select("user_id")
        .eq("user_id", userId)
        .single();

      if (!existingUser) {
        const { error: insertError } = await supabase.from("users").upsert([
          {
            user_id: userId,
            email: email,
            created_at: new Date().toISOString()
          }
        ]);

        if (insertError) {
          console.error("❌ Błąd zapisu do bazy:", insertError.message);
        } else {
          console.log("✅ Nowy użytkownik zapisany do bazy!");
        }
      } else {
        console.log("ℹ️ Użytkownik już istnieje w bazie.");
      }

      botButton.addEventListener("click", (e) => {
        e.preventDefault();
        const link = `https://t.me/Persxfinance_bot?start=${userId}`;
        window.open(link, "_blank");

        step2.style.display = "none";
        step3.style.display = "block";
      });
    });
  </script>
</body>

</html>