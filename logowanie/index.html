<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <title>Finxplaner login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/finxplaner-login.webflow.css" rel="stylesheet" type="text/css">
</head>

<body>
  <div class="loginwrapper">
    <div class="login_window_wrapper">
      <div class="text-block-2">FINANCEXPLANER</div>
      <div class="div-block">
        <h1 class="heading">Logowanie</h1>
        <div class="w-form">
          <form id="email-input" name="email-form" data-name="Email Form" method="get" class="form">
            <label for="email" class="field-label">Adres e-mail</label>
            <input class="text-field w-input" maxlength="256" name="email" placeholder="" type="email" id="email"
              required="">
            <input type="button" id="login-button" class="submit-button w-button" value="Zaloguj się">
          </form>
        </div>
      </div>
      <a href="#" class="link">Zapomniałeś hasła? Zresetuj je tutaj</a>
    </div>
    <div class="left-photo">
      <div>
        <div class="text-block-3">Oszczędzamy Twój czas, <span class="text-span">pomagając Ci zarządzać</span> Twoimi
          finansami</div>
      </div>
    </div>
    <div class="right-color"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://vptpascqhmpmgnufevks.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdHBhc2NxaG1wbWdudWZldmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NTcwNDEsImV4cCI6MjA2MzIzMzA0MX0.5Vtk65gjiUG0VrBqbukwikF02SX5z55xV-Ag3U4CGp0'
    );

    document.addEventListener("DOMContentLoaded", async () => {
      const emailInput = document.getElementById("email");
      const loginButton = document.getElementById("login-button");

      loginButton.addEventListener("click", async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim();
        if (!email) return alert("Wpisz poprawny e-mail");

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: "https://finance-seven-sigma.vercel.app/configstep1/index.html"
          }
        });

        if (error) {
          alert("Błąd logowania: " + error.message);
        } else {
          alert("Sprawdź maila – wysłaliśmy Ci link do logowania.");
        }
      });

      // Jeśli wróciliśmy z magic linka
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (session?.user) {
          await supabase.from("users").upsert([
            {
              user_id: session.user.id,
              email: session.user.email,
              created_at: new Date().toISOString()
            }
          ]);
          window.location.href = "/configstep1/index.html";
        }
      });
    });
  </script>
</body>

</html>